<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MeetingApp.Models.ViewModels"
             x:Class="MeetingApp.Pages.MeetingDetailPage"
             x:DataType="vm:MeetingDetailViewModel"
             xmlns:models="clr-namespace:MeetingApp.Models"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:dtos="clr-namespace:MeetingApp.Models.Dtos"
             Title="Detail Schůzky">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">

            <Label Text="Název schůzky"/>
            <Entry Text="{Binding SelectedMeeting.Title}" Placeholder="Zadejte název"/>

            <Label Text="Datum"/>
            <DatePicker Date="{Binding SelectedMeeting.Date}"/>

            <Label Text="Začátek"/>
            <TimePicker Time="{Binding SelectedMeeting.StartTime}" />

            <Label Text="Konec"/>
            <TimePicker Time="{Binding SelectedMeeting.EndTime}"/>

            <Label Text="Opakování"/>
            <Picker ItemsSource="{Binding RecurrencePatterns}"
                    SelectedItem="{Binding Pattern}" />

            <Label Text="Do kdy opakovat"/>
            <DatePicker Date="{Binding EndDate}"
                        MinimumDate="{x:Static sys:DateTime.Today}" />

            <!-- Přidání účastníka -->
            <SearchBar Text="{Binding SearchText}"
                       Placeholder="Hledat účastníka..." />
            <CollectionView ItemsSource="{Binding FilteredUsers}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dtos:UserDto">
                        <Label Text="{Binding FullName}">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MeetingDetailViewModel}}, Path=SelectUserCommand}"
                                    CommandParameter="{Binding .}" />
                            </Label.GestureRecognizers>
                        </Label>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <!-- Účastníci -->
            <Label Text="Účastníci" FontAttributes="Bold"/>
            <CollectionView ItemsSource="{Binding Participants}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dtos:UserDto">
                        <Grid Padding="5" ColumnDefinitions="*,*,Auto">
                            <Label Text="{Binding FullName}" Grid.Column="0"/>
                            <Label Text="{Binding Email}" Grid.Column="1"/>
                            <Button Text="🗑"
                        Grid.Column="2"
                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MeetingDetailViewModel}}, Path=RemoveParticipantCommand}"
                        CommandParameter="{Binding .}" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Button Text="Uložit změny" Command="{Binding SaveChangesCommand}"/>
            <Button Text="Smazat schůzku" Command="{Binding DeleteMeetingCommand}" BackgroundColor="DarkRed" TextColor="White"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
